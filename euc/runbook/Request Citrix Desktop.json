{"status":{},"contains_secrets":false,"product_version":"3.1.1","spec":{"description":"","resources":{"client_attrs":{"b1268f9b_deployment":{"y":508.4943237305,"x":539.3664550781}},"service_definition_list":[{"singleton":false,"action_list":[{"description":"System action for creating an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CitrixDDC"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"57e4af90_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"c01d1423_runbook","main_task_local_reference":{"kind":"app_task","name":"57e4af90_dag"},"variable_list":[]},"name":"action_create"},{"description":"System action for deleting an application. Deletes created VMs as well","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CitrixDDC"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"7573b981_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"2077fece_runbook","main_task_local_reference":{"kind":"app_task","name":"7573b981_dag"},"variable_list":[]},"name":"action_delete"},{"description":"System action for starting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CitrixDDC"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"bcc1e702_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"4479f16a_runbook","main_task_local_reference":{"kind":"app_task","name":"bcc1e702_dag"},"variable_list":[]},"name":"action_start"},{"description":"System action for stopping an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CitrixDDC"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6af111e5_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"8723f217_runbook","main_task_local_reference":{"kind":"app_task","name":"6af111e5_dag"},"variable_list":[]},"name":"action_stop"},{"description":"System action for restarting an application","type":"system","critical":false,"runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_service","name":"CitrixDDC"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"f29adaa7_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"19d4ed87_runbook","main_task_local_reference":{"kind":"app_task","name":"f29adaa7_dag"},"variable_list":[]},"name":"action_restart"}],"depends_on_list":[],"name":"CitrixDDC","port_list":[],"tier":"","variable_list":[{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"PC_IP","value":"","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"This must exactly match your Citrix Delivery Group name as it appears in Desktop Studio","data_type":"BASE","type":"LOCAL","name":"DG","value":"","label":"","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"This must exactly match the name of your Citrix Machine Catalog as it appears in Desktop Studio","data_type":"BASE","type":"LOCAL","name":"CLOUD_MC","value":"","label":"Cloud (AWS) Cluster Machine Catalog Name","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"This must exactly match the name of your Citrix Machine Catalog as it appears in Desktop Studio","data_type":"BASE","type":"LOCAL","name":"ONPREM_MC","value":"","label":"On-Prem (HPOC) Cluster Machine Catalog Name","attrs":{"type":""},"editables":{"value":false},"is_hidden":true,"options":{"type":"PREDEFINED","choices":[]}}],"description":""}],"substrate_definition_list":[{"description":"","action_list":[],"type":"EXISTING_VM","name":"VM1","readiness_probe":{"connection_type":"POWERSHELL","retries":"5","connection_protocol":"http","connection_port":5985,"address":"@@{ip_address}@@","delay_secs":"60","disable_readiness_probe":false,"login_credential_local_reference":{"kind":"app_credential","name":"NTNXLAB Administrator"}},"editables":{"create_spec":{"address":true}},"os_type":"Windows","create_spec":{"type":"PROVISION_EXISTING_MACHINE","address":"10.42.93.44"},"variable_list":[]}],"credential_definition_list":[{"username":"NTNXLAB\\Administrator","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"NTNXLAB Administrator"},{"username":"admin","description":"","type":"PASSWORD","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"PrismAdmin"}],"package_definition_list":[{"description":"","action_list":[],"type":"DEB","service_local_reference_list":[{"kind":"app_service","name":"CitrixDDC"}],"name":"Package1","version":"","options":{"install_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Get PC IP"},{"kind":"app_task","name":"Get Cluster VIPs"},{"kind":"app_task","name":"AWS Mem Usage"},{"kind":"app_task","name":"HPOC Mem Usage"},{"kind":"app_task","name":"Add Desktop"}],"name":"a392510a_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Get PC IP"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Get Cluster VIPs"}},{"from_task_reference":{"kind":"app_task","name":"Get Cluster VIPs"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"AWS Mem Usage"}},{"from_task_reference":{"kind":"app_task","name":"AWS Mem Usage"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"HPOC Mem Usage"}},{"from_task_reference":{"kind":"app_task","name":"HPOC Mem Usage"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Add Desktop"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"CitrixDDC"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get PC IP","attrs":{"exit_status":[],"script":"jwt = '@@{calm_jwt}@@'\n\n# Get PC IP and PE uuid\napi_url = 'https:\/\/localhost:9440\/api\/nutanix\/v3\/prism_central'\nheaders = {'Content-Type': 'application\/json', 'Accept': 'application\/json', 'Authorization': 'Bearer {}'.format(jwt)}\n\nr = urlreq(api_url, verb='GET', headers=headers, verify=False)\nif r.ok:\n    resp = json.loads(r.content)\n\n    pc_ip = resp['resources']['pc_vm_list'][0]['nic_list'][0]['ip_list'][0]\n    pe_uuid= resp['resources']['pc_vm_list'][0]['cluster_reference']['uuid']\n    storage_container = resp['resources']['pc_vm_list'][0]['container_uuid']\n\nelse:\n    print(\"Post request failed\", r.content)\n    exit(1)\n\nprint(\"PC_IP={}\".format(pc_ip))\nprint(\"PE_UUID={}\".format(pe_uuid))\nprint(\"SC_UUID={}\".format(storage_container))","eval_variables":["PC_IP"],"eval_scope":"local","type":"","script_type":"static"},"timeout_secs":"0","type":"SET_VARIABLE","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"CitrixDDC"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Get Cluster VIPs","attrs":{"expected_response_params":[{"status":"SUCCESS","code":200,"type":""}],"request_body":"{\n  \"kind\": \"cluster\",\n  \"sort_attribute\": \"name\",\n  \"length\": 5,\n  \"sort_order\": \"ASCENDING\",\n  \"offset\": 0\n}","headers":[],"url":"https:\/\/@@{PC_IP}@@:9440\/api\/nutanix\/v3\/clusters\/list","response_paths":{"AWS_CLUSTER_IP":"$.entities[0].spec.resources.network.external_ip","HPOC_CLUSTER_IP":"$.entities[1].spec.resources.network.external_ip"},"retry_interval":1,"method":"POST","retry_count":1,"authentication":{"type":"basic_with_cred","credential_local_reference":{"kind":"app_credential","name":"PrismAdmin"}},"tls_verify":false,"content_type":"application\/json","connection_timeout":120,"type":"HTTP","proxy_type":""},"timeout_secs":"0","type":"HTTP","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"CitrixDDC"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"AWS Mem Usage","attrs":{"expected_response_params":[{"status":"SUCCESS","code":200,"type":""}],"request_body":"","headers":[],"url":"https:\/\/@@{AWS_CLUSTER_IP}@@:9440\/PrismGateway\/services\/rest\/v2.0\/cluster\/","response_paths":{"CLOUD_MEM_USAGE":"$.stats.hypervisor_memory_usage_ppm"},"retry_interval":1,"method":"GET","retry_count":1,"authentication":{"type":"basic_with_cred","credential_local_reference":{"kind":"app_credential","name":"PrismAdmin"}},"tls_verify":false,"content_type":"application\/json","connection_timeout":120,"type":"","proxy_type":""},"timeout_secs":"0","type":"HTTP","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"CitrixDDC"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"HPOC Mem Usage","attrs":{"expected_response_params":[{"status":"SUCCESS","code":200,"type":""}],"request_body":"","headers":[],"url":"https:\/\/@@{HPOC_CLUSTER_IP}@@:9440\/PrismGateway\/services\/rest\/v2.0\/cluster\/","response_paths":{"ONPREM_MEM_USAGE":"$.stats.hypervisor_memory_usage_ppm"},"retry_interval":1,"method":"GET","retry_count":1,"authentication":{"type":"basic_with_cred","credential_local_reference":{"kind":"app_credential","name":"PrismAdmin"}},"tls_verify":false,"content_type":"application\/json","connection_timeout":120,"type":"","proxy_type":""},"timeout_secs":"0","type":"HTTP","variable_list":[]},{"target_any_local_reference":{"kind":"app_service","name":"CitrixDDC"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Add Desktop","attrs":{"exit_status":[],"script":"# If on-prem cluster memory utilization > 20% OR cloud cluster memory utilization is < on-prem, provision new desktop to cloud cluster, otherwise, provision on-prem\nif (@@{ONPREM_MEM_USAGE}@@ -gt 200000 -or @@{CLOUD_MEM_USAGE}@@ -lt @@{ONPREM_MEM_USAGE}@@) {\n\t$catalogName = \"@@{CLOUD_MC}@@\"\n} else {\n\t$catalogName = \"@@{ONPREM_MC}@@\"\n}\n\n$deliveryGroup = \"@@{DG}@@\"\n\n# Create new machine account in AD\n$identityPool = Get-AcctIdentityPool -IdentityPoolName $catalogName\n$identityPool.IdentityPoolUid\n$newADAccount = New-AcctADAccount -Count 1 -IdentityPoolUid $identityPool.IdentityPoolUid\n$newADAccount\n\n# Provision VM\n$provVM = New-ProvVM -ADAccountName @($newADAccount.SuccessfulAccounts[0].ADAccountName) -ProvisioningSchemeName $catalogName\n$provVM\n\n# Add VM to Machine Catalog\nLock-ProvVM -ProvisioningSchemeName $catalogName -Tag \"Brokered\" -VMID @($provVM.CreatedVirtualMachines[0].VMId)\n$brokerCatalog = Get-BrokerCatalog -Name $catalogName\n$brokerCatalog\n$brokerMachine = New-BrokerMachine -CatalogUid $brokerCatalog.Uid -MachineName $provVM.CreatedVirtualMachines[0].ADAccountSid\n\n# Clean up provisioning task from DB because you care about the environment\nRemove-ProvTask -TaskId $provVM.TaskId\n\n# Add VM to Delivery Group\nAdd-BrokerMachine -DesktopGroup $deliveryGroup -InputObject $brokerMachine","script_type":"npsscript","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"NTNXLAB Administrator"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"93b70d6a_runbook","main_task_local_reference":{"kind":"app_task","name":"a392510a_dag"},"variable_list":[]},"type":"","uninstall_runbook":{"task_definition_list":[{"target_any_local_reference":{"kind":"app_package","name":"Package1"},"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"6dd073c4_dag","attrs":{"edges":[],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]}],"description":"","name":"c6f0d829_runbook","main_task_local_reference":{"kind":"app_task","name":"6dd073c4_dag"},"variable_list":[]}},"variable_list":[]}],"app_profile_list":[{"deployment_create_list":[{"type":"GREENFIELD","action_list":[],"name":"b1268f9b_deployment","min_replicas":"1","default_replicas":"1","depends_on_list":[],"published_service_local_reference_list":[],"max_replicas":"1","package_local_reference_list":[{"kind":"app_package","name":"Package1"}],"substrate_local_reference":{"kind":"app_substrate","name":"VM1"},"variable_list":[],"description":""}],"description":"","action_list":[],"name":"Default","variable_list":[]}],"published_service_definition_list":[],"default_credential_local_reference":{"kind":"app_credential","name":"NTNXLAB Administrator"},"type":"USER"},"name":"Request Citrix Desktop"},"api_version":"3.0","metadata":{"last_update_time":"1612132279530964","kind":"blueprint","spec_version":30,"creation_time":"1612120631518118","name":"Request Citrix Desktop"}}